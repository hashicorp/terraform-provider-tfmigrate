name: Mend PR Security Scan

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  mend-scan:
    runs-on: [self-hosted, linux]
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Run Mend Security Scan
        uses: hashicorp/oss-core-library-dashboard-metrics/mend-security/actions/mend-pr-scan@main
        with:
          vault-url: ${{ vars.CI_VAULT_URL }}
          vault-method: ${{ vars.CI_VAULT_METHOD }}
          vault-path: ${{ vars.CI_VAULT_PATH }}
          vault-jwt-github-audience: ${{ vars.CI_VAULT_AUD }}
          generate-scan-report: "true"
          npm-include-dev-dependencies: "true"
          scan-timeout-minutes: "30"
          psirt-id: "PSIRT_PRD0014263"
      
      - name: Upload Scan Artifacts
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
        if: always()
        with:
          name: mend-scan-results-pr-${{ github.event.number }}
          path: whitesource/**
          retention-days: 90
